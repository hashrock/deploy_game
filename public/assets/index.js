var e,t,s=Object.defineProperty,o=(e,t,o)=>(((e,t,o)=>{t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o})(e,"symbol"!=typeof t?t+"":t,o),o);import{A as n,s as i,S as r,T as a,a as d,L as c,b as l,C as u,c as x}from"./vendor.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerpolicy&&(t.referrerPolicy=e.referrerpolicy),"use-credentials"===e.crossorigin?t.credentials="include":"anonymous"===e.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class y extends u{constructor(e,t,s){super(),o(this,"vx",0),o(this,"vy",0),o(this,"tx",0),o(this,"ty",0),o(this,"_text",new a("HELLO",{})),o(this,"_sprite"),this._sprite=new x(e),this.x=t,this.y=s,this.tx=t,this.ty=s,this.addChild(this._sprite),this._sprite.position.set(0,0),this._sprite.anchor.set(.5),this._sprite.animationSpeed=.5,this.addChild(this._text),this._text.position.set(0,-50)}set text(e){this._text.text=e}}const h=new n({width:window.innerWidth,height:window.innerHeight,antialias:!1,resolution:1});let p=[];const f={};null==(e=document.querySelector("#canvas"))||e.appendChild(h.view),i.SCALE_MODE=r.NEAREST;const m=[],g=[];function b(e){e.vx=0,e.vy=0;const t=e.tx-e.x,s=e.ty-e.y,o=t**2+s**2,n=Math.sqrt(o);if(0!==n){const o=n/5,i=t/o,r=s/o;e.vx=Math.round(i),e.vy=Math.round(r)}e.scale.y=4,0==e.vx&&0==e.vy||(e.vx>0?e._sprite.scale.x=4:e._sprite.scale.x=-4,e.vy>0?e._sprite.textures=m:e._sprite.textures=g),e._sprite.play()}function v(e){e.x+=e.vx,e.y+=e.vy,Math.abs(e.tx-e.x)<=Math.abs(e.vx)&&(e.vx=0,e.x=e.tx),Math.abs(e.ty-e.y)<=Math.abs(e.vy)&&(e.vy=0,e.y=e.ty),0===e.vx&&0===e.vy&&e._sprite.gotoAndStop(0)}const w={};function E(){return w[_.id]}function C(e,t){const s=new y(m,e,t);return s._sprite.play(),s}const S={};let N=new a("",{fontSize:16});let O="";const _={id:(k=(new Date).getTime(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=(k+16*Math.random())%16|0;return k=Math.floor(k/16),("x"==e?t:3&t|8).toString(16)}))),name:function(){const e=["apple","banana","cherry","durian","elderberry","fig","grape","huckleberry","jackfruit","kiwi","lemon","mango","nectarine","orange","papaya","quince","raspberry","strawberry","tangerine","watermelon","zucchini","alligator","ant","bear","bee","bird","camel","cat","cheetah","chicken","chimpanzee","cow","crocodile","deer","dog","dolphin","duck","eagle","elephant","fish","fly","fox","frog","giraffe","goat","goldfish","hamster","hippopotamus","horse","kangaroo","kitten","lion","lobster","monkey","octopus","owl","panda","pig","puppy","rabbit","rat","scorpion","seal","shark","sheep","snail","snake","spider","squirrel","tiger","turtle","wolf","zebra"];return`${e[Math.floor(Math.random()*e.length)]}saurs`}(),position:{x:300,y:300},ts:0};var k;setInterval((()=>{"CONNECTED"===O&&async function(){await fetch("/api/send",{method:"POST",body:JSON.stringify({user:_,type:"alive",body:""})})}()}),2e3);const M=new EventSource("/api/listen");M.addEventListener("open",(()=>O="CONNECTED")),M.addEventListener("error",(()=>{switch(M.readyState){case EventSource.OPEN:O="CONNECTED";break;case EventSource.CONNECTING:O="CONNECTING";break;case EventSource.CLOSED:O="DISCONNECTED"}})),M.addEventListener("message",(e=>{const t=JSON.parse(e.data);if("message"===t.type&&(f[t.user.id]={id:t.id,body:t.body,ts:t.ts,user:t.user},p.push({id:t.id,body:t.body,ts:t.ts,user:t.user}),p=p.slice(-10),N.text=p.map((e=>`${e.user.name}: ${e.body}`)).join("\n")),"alive"===t.type){let e=w[t.user.id];e||(e=C(t.user.position.x,t.user.position.y),h.stage.addChild(e),w[t.user.id]=e),t.user.id!==_.id&&(e.tx=t.user.position.x,e.ty=t.user.position.y),b(e),S[t.user.id]=t.user,Object.keys(S).forEach((e=>{S[e].ts<Date.now()-1e4&&(delete S[e],h.stage.removeChild(w[e]))}))}}));const $=d.from("bg.png",{});$.scale.set(4),$.x=0,$.y=0,h.stage.addChild($),c.shared.add("deno.json").load((()=>{!function(e){for(let n=0;n<4;n++)m.push(l.from(`deno ${n}.aseprite`,{},!1));for(let n=4;n<8;n++)g.push(l.from(`deno ${n}.aseprite`,{},!1));const t=C(Math.floor(Math.random()*h.stage.width),Math.floor(Math.random()*h.stage.height));w[e.id]=t,h.stage.addChild(t),h.stage.addChild(t._text);const s=new a(`${e.name}`,{fontSize:16});s.x=0,s.y=100,h.stage.addChild(s),N.x=600,N.y=0,h.stage.addChild(N),h.stage.interactive=!0,h.stage.on("pointerdown",(e=>{const t=E();t.tx=e.data.global.x,t.ty=e.data.global.y,b(t)}));const o=()=>{for(const e of Object.keys(w))v(w[e]);for(const t of Object.keys(w)){const o=w[t],n=S[t];n&&(s.text="",e.id===t&&(s.text+="(me) "),s.text+=`${n.name} x:${o.x} y:${o.y} tx:${o.tx} ty:${o.ty} \n`)}for(const o of Object.keys(w)){const n=w[o],i=S[o];i&&(f[o]&&(t.text=f[o].user.name+"\n"+f[o].body),s.text="",e.id===o&&(s.text+="(me) "),s.text+=`${i.name} x:${n.x} y:${n.y} tx:${n.tx} ty:${n.ty} \n`)}e.position.x=E().tx,e.position.y=E().ty,setTimeout(o,16)};o()}(_)})),null==(t=document.querySelector("#messageForm"))||t.addEventListener("submit",(e=>{e.preventDefault();const t=document.querySelector("#messageInput"),s=t.value;t.value="",async function(e){0!==e.length&&await fetch("/api/send",{method:"POST",body:JSON.stringify({user:_,type:"message",body:e})})}(s)}));
